import{_ as f,d as m,o as r,c as n,b as s,t as l,a as h,f as g,w as v,T as F,e as d,g as u,v as w,h as b,n as S,F as U,u as y,i as k,x as c}from"./index-7bc09754.js";let p=null;const C=m({name:"UploadFileView",setup(){return{devicesStore:y(),firmwareUpdateStore:k(),xbit:c}},data(){return{jsonDataListener:null,selectedFile:null,progressText:null,uploading:!1,errorText:null,targetFile:"",targetPath:""}},async mounted(){const e=await c.sendBleGetGattDictionaryCommand({deviceAddress:this.devicesStore.connected});let t=null;for(const i of e.services)if(i.serviceUuid.toUpperCase()===this.firmwareUpdateStore.GUID_SERVICE_SMP){for(const a of i.characteristics)if(a.characteristicUuid.toUpperCase()===this.firmwareUpdateStore.GUID_SMP){t=this.firmwareUpdateStore.GUID_SMP;break}}if(!t)return Promise.reject(new Error("SMP not found"));await this.xbit.sendBleNotifyEnableCommand({uuid:t,deviceAddress:this.devicesStore.connected}),this.jsonDataListener=i=>{if(i.method==="filePickerSelected"){const a={target:{files:[{name:a.params.name,size:a.params.imageData.length,path:"",lastModified:Date.now()}]}};this.selectFile(a)}},c.addEventListener("bluetoothNotificationReceived",this.jsonDataListener),c.addEventListener("filePickerSelected",this.jsonDataListener)},methods:{async selectFile(e){this.progressText="Loading File...";const t=await e.target.files[0];if(t){const i=new FileReader;i.onload=async a=>{p=new Uint8Array(a.target.result),this.selectedFile={name:t.name,size:t.size,path:t.path,lastModified:t.lastModified},this.targetFile=this.selectedFile.name,this.targetPath="/lfs1/scripts",this.targetFile=this.targetFile.replace(/\s/g,"-"),this.targetFile=this.targetFile.replace(/[^a-zA-Z0-9-_.]/g,""),this.targetPath=this.targetPath.replace(/\/+$/,""),this.progressText=null},i.readAsArrayBuffer(t)}},deselectFile(){this.selectedFile=null,p=null,this.progressText=null},uploadFile(){this.uploading=!0,this.firmwareUpdateStore.mcumgr.onFileUploadProgress(({percentage:t})=>{this.progressText="\rUploading... "+t+"%"}),this.firmwareUpdateStore.mcumgr.onFileUploadNext(async({packet:t})=>await this.xbit.sendBleWriteCommand({data:t,uuid:this.firmwareUpdateStore.smpCharId,deviceAddress:this.devicesStore.connected})),this.firmwareUpdateStore.mcumgr.onFileUploadFinished(()=>{this.progressText="File upload complete",this.uploading=!1,setTimeout(()=>{this.deselectFile()},5e3)});const e=this.targetPath+"/"+this.targetFile;this.firmwareUpdateStore.mcumgr.cmdUploadFile(p,e)}},async beforeRouteLeave(e){}}),P={class:"pl-4 p-2 mb-2 text-white btn-gradient-1"},T={class:"p-2"},_={class:"grow max-w-md pl-4"},x={class:"flex flex-row w-full"},D={class:"p-2 m-2 text-white bg-canvas-slate-700 grow"},M=s("i",{class:"fa-solid fa-file-code"},null,-1),A={key:0,class:"bg-canvas-slate-700 text-white p-2 m-2"},L=s("i",{class:"fa-solid fa-microchip py-2 my-2"},null,-1),I=s("i",{class:"fas fa-times"},null,-1),N=[I],z={key:0,class:"text-white m-2 p-2 bg-canvas-sky-700"},B=s("div",{class:"mb-1"},[s("i",{class:"fas fa-info-circle"}),h(" Uploading a file will overwrite the existing file with the same name on the device. ")],-1),E={key:0},V={key:1,class:"flex"},$={class:"p-1"},j={class:"grow"},G={key:1,class:"text-white m-2 p-2 bg-canvas-sky-700"},R={class:"fa-solid fa-spinner fa-spin"},W={key:2,class:"text-white m-2 p-2 bg-canvas-pink-300"},Z={class:"action-button btn-gradient-1",style:{"justify-self":"flex-end"}},q=["disabled"];function H(e,t,i,a,J,K){return r(),n(U,null,[s("h3",P,[s("span",T," Connected to "+l(e.xbit.formatAddress(e.devicesStore.connected)),1)]),s("div",_,[s("div",x,[s("div",D,[s("label",{class:"bg-canvas-slate-600 text-white p-2 rounded cursor-pointer block text-center",for:"fileInput",onClick:t[0]||(t[0]=(...o)=>e.filePicker&&e.filePicker(...o))},[M,h(" Select File to Upload to "+l(e.xbit.formatAddress(e.devicesStore.connected)),1)]),s("input",{type:"file",id:"fileInput",onChange:t[1]||(t[1]=(...o)=>e.selectFile&&e.selectFile(...o)),class:"hidden"},null,32)])]),g(F,{name:"fade",mode:"out-in"},{default:v(()=>[e.selectedFile?(r(),n("div",A,[s("h3",null,[L,h(" Selected File "),s("button",{onClick:t[2]||(t[2]=o=>e.deselectFile()),class:"float-right text-canvas-slate-500 hover:text-white"},N)]),s("div",null,"File Name: "+l(e.selectedFile.name),1),s("div",null,"File Last Modified: "+l(e.xbit.toDate(e.selectedFile.lastModified)),1),s("div",null,"File Size: "+l(e.selectedFile.size),1)])):d("",!0)]),_:1}),e.progressText?d("",!0):(r(),n("div",z,[B,e.targetFile?(r(),n("div",E,"File will be uploaded to:")):d("",!0),e.targetFile?(r(),n("div",V,[s("div",$,l(e.targetPath)+"/",1),s("div",j,[u(s("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=o=>e.targetFile=o),class:"bg-canvas-slate-600 text-white p-1 rounded",style:{width:"100%"}},null,512),[[w,e.targetFile]])])])):d("",!0)])),e.progressText?(r(),n("div",G,[u(s("i",R,null,512),[[b,e.uploading]]),h(" "+l(e.progressText),1)])):d("",!0),e.errorText?(r(),n("div",W,l(e.errorText),1)):d("",!0)]),s("div",Z,[s("button",{onClick:t[4]||(t[4]=o=>e.uploadFile()),disabled:!e.selectedFile||e.uploading,class:S(["bg-canvas-slate-800 p-4 w-full h-full",{"text-white cursor-pointer":e.selectedFile,"text-gray-600 cursor-not-allowed":!e.selectedFile}])}," Upload File ",10,q)])],64)}const Q=f(C,[["render",H]]);export{Q as default};
