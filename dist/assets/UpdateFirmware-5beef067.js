import{_ as U,d as v,o as i,c as r,b as t,t as o,F as w,r as g,f as b,w as y,T as _,a as d,e as h,x as n,i as k,u as T,j as c,n as S}from"./index-fc19ca09.js";const D=v({name:"UpdateFirmwareView",setup(){const e="DA2E7828-FBCE-4E01-AE9E-261174997C48";return{xbit:n,firmwareUpdateStore:k(),GUID_SMP:e,devicesStore:T()}},data(){return{images:[],selectedFile:!1,pendingFile:!1,jsonDataListener:null,progressInfo:"",updateFirmwareAction:"Update Firmware",settingUpSmp:!1,readingImageState:!1,testingImageState:!1,confirmingImageState:!1,erasingImage:!1,resetting:!1,uploading:!1,testButtonDisabled:!0,confirmButtonDisabled:!0,eraseButtonDisabled:!1}},async mounted(){this.devicesStore.connected||this.$router.push({name:"scan"}),this.firmwareUpdateStore.mcumgr.onMessage(async({op:e,group:s,id:f,data:l,length:p})=>{switch(s){case c.MGMT_GROUP_ID_OS:switch(f){case c.OS_MGMT_ID_ECHO:alert(l.r);break;case c.OS_MGMT_ID_TASKSTAT:console.table(l.tasks);break;case c.OS_MGMT_ID_MPSTAT:console.log(l);break}break;case c.MGMT_GROUP_ID_IMAGE:switch(f){case c.IMG_MGMT_ID_STATE:this.firmwareUpdateStore.processReadStateResponse(l)}}}),this.jsonDataListener=e=>{if(e.method==="filePickerSelected"){const s={target:{files:[{name:s.params.name,size:s.params.imageData.length,path:"",lastModified:Date.now()}]}};this.selectFile(s)}},n.addEventListener("bluetoothNotificationReceived",this.jsonDataListener),n.addEventListener("filePickerSelected",this.jsonDataListener),this.$watch("devicesStore.connected",async e=>{if(e)n.sendClearToast();else{if(this.firmwareUpdateStore.resetting)return;this.firmwareUpdateStore.uploading||this.firmwareUpdateStore.deselectFile(),n.sendToast({type:"error",message:"Disconnected"}),this.persistConnection?await this.devicesStore.connectDevice(this.devicesStore.selected):this.$router.push({name:"scan"})}}),this.$watch("firmwareUpdateStore.state",async e=>{e===0?setTimeout(()=>{this.stateAction()},1e3):e===1&&setTimeout(()=>{this.stateAction()},1e3)}),this.firmwareUpdateStore.setState(0)},async beforeRouteLeave(){if(n.removeEventListener("jsonData",this.jsonDataListener),this.firmwareUpdateStore.uploading)return n.sendToast({type:"error",message:"Uploading in progress, please wait."}),!1;this.firmwareUpdateStore.resetStateMachine()},methods:{async stateAction(){if(this.firmwareUpdateStore.state===0)try{await this.firmwareUpdateStore.detectSmp(),this.nextState()}catch(e){console.log("error detecting  SMP",e)}else if(this.firmwareUpdateStore.state===1)try{await this.firmwareUpdateStore.readImageState()}catch(e){console.error("error reading image state",e)}else this.firmwareUpdateStore.state===2?this.firmwareUpdateStore.imageUpload():this.firmwareUpdateStore.state===3?this.firmwareUpdateStore.imageTest():this.firmwareUpdateStore.state===4?this.reset():this.firmwareUpdateStore.state===5?this.firmwareUpdateStore.eraseImage():this.firmwareUpdateStore.state===6?this.firmwareUpdateStore.imageConfirm():this.firmwareUpdateStore.state===7&&this.$router.back()},nextState(){this.firmwareUpdateStore.setState(this.firmwareUpdateStore.state+1)},async reset(){if(this.firmwareUpdateStore.state===4)return n.sendToast({message:"Resetting... Please wait.",options:{autoClose:!1}}),this.firmwareUpdateStore.currentState.busy=!0,await n.sendBleWriteCommand({data:this.firmwareUpdateStore.mcumgr.cmdReset(),uuid:this.firmwareUpdateStore.smpCharId,deviceAddress:this.devicesStore.connected}),await this.devicesStore.startScanning(120*1e3),new Promise((e,s)=>{const f=setTimeout(async()=>{await this.devicesStore.stopScanning(device),this.firmwareUpdateStore.currentState.busy=!1,s()},12e4),l=setInterval(async()=>{for(const p of this.devicesStore.devices)if(p.address===this.devicesStore.selected){clearInterval(l),clearTimeout(f),this.firmwareUpdateStore.currentState.busy=!1;try{await this.devicesStore.stopScanning(p),await this.devicesStore.connectDevice(p),this.firmwareUpdateStore.setState(0)}catch(u){console.error("error resetting",u)}e();break}},1e3)})},filePicker(){n.sendFilePickerCommand({accept:".bin"})},deselectFile(){this.firmwareUpdateStore.deselectFile();try{this.$refs.fileInput.value=""}catch{}}}}),F={class:"pl-4 p-2 mb-2 text-white btn-gradient-1"},I={class:"p-2"},M={class:"flex flex-col",style:{flex:"1 1 auto","overflow-y":"auto","overflow-x":"hidden"}},C={class:"flex max-[575px]:flex-col w-full"},A=t("i",{class:"fa-solid fa-microchip py-2 my-2"},null,-1),E=["disabled"],P=t("i",{class:"fa-solid fa-trash-can"},null,-1),$=[P],G={key:0},L=t("i",{class:"fa-solid fa-arrows-rotate fa-spin"},null,-1),B=[L],R={key:1},j={class:"whitespace-nowrap"},x={key:2,class:"mt-2"},O=t("i",{class:"fa-solid fa-file-code"},null,-1),V={key:0,class:"bg-canvas-slate-700 text-white p-2 m-2"},N=t("i",{class:"fa-solid fa-microchip py-2 my-2"},null,-1),z=t("i",{class:"fas fa-times"},null,-1),H=[z],K={key:0,class:"text-white m-2 p-2 bg-canvas-sky-700"},W=t("i",{class:"fa-solid fa-spinner fa-spin"},null,-1),q={key:1,class:"text-white m-2 p-2 bg-canvas-sky-700"},J={key:2,class:"text-white m-2 p-2 bg-canvas-pink-300"},Q={class:"action-button btn-gradient-1"},X=["disabled"];function Y(e,s,f,l,p,u){return i(),r(w,null,[t("h3",F,[t("span",I," Connected to "+o(e.xbit.formatAddress(e.devicesStore.connected)),1)]),t("div",M,[t("div",C,[(i(!0),r(w,null,g(e.firmwareUpdateStore.images,a=>(i(),r("div",{key:a.slot,class:"p-2 m-2 text-white bg-canvas-slate-700 grow"},[t("h3",null,[A,d(" Slot "+o(a.slot+1)+" ",1),a.slot===1&&!e.uploading&&!a.empty?(i(),r("button",{key:0,class:"bg-canvas-slate-600 text-white p-2 m-2 rounded disabled:opacity-25 float-right",onClick:s[0]||(s[0]=(...m)=>e.firmwareUpdateStore.imageErase&&e.firmwareUpdateStore.imageErase(...m)),disabled:e.firmwareUpdateStore.states[5].busy},$,8,E)):h("",!0)]),e.firmwareUpdateStore.erasing||e.firmwareUpdateStore.reading?(i(),r("div",G,B)):a.empty?h("",!0):(i(),r("div",R,[t("div",j,"Version: "+o(a.version),1),t("div",null,[d("Pending "),t("i",{class:S({"fa-solid fa-circle-check":a.pending,"fa-regular fa-circle":!a.pending})},null,2)]),t("div",null,[d("Confirmed "),t("i",{class:S({"fa-solid fa-circle-check":a.confirmed,"fa-regular fa-circle":!a.confirmed})},null,2)]),t("div",null,[d("Bootable "),t("i",{class:S({"fa-solid fa-circle-check":a.bootable,"fa-regular fa-circle":!a.bootable})},null,2)])])),a.slot===1?(i(),r("div",x,[t("label",{class:"bg-canvas-slate-600 text-white p-2 rounded cursor-pointer block text-center",for:"fileInput",onClick:s[1]||(s[1]=(...m)=>e.filePicker&&e.filePicker(...m))},[O,d(" Select Update Image To Upload ")]),t("input",{type:"file",id:"fileInput",onChange:s[2]||(s[2]=(...m)=>e.firmwareUpdateStore.selectFile&&e.firmwareUpdateStore.selectFile(...m)),class:"hidden",accept:".bin"},null,32)])):h("",!0)]))),128))]),b(_,{name:"fade",mode:"out-in"},{default:y(()=>[e.firmwareUpdateStore.selectedFile?(i(),r("div",V,[t("h3",null,[N,d(" Selected File "),t("button",{onClick:s[3]||(s[3]=a=>e.deselectFile()),class:"float-right text-canvas-slate-500 hover:text-white"},H)]),t("div",null,"Version: "+o(e.firmwareUpdateStore.selectedFile.version),1),t("div",null,"File Name: "+o(e.firmwareUpdateStore.selectedFile.name),1),t("div",null,"File Last Modified: "+o(e.xbit.toDate(e.firmwareUpdateStore.selectedFile.lastModified)),1),t("div",null,"Image Size: "+o(e.firmwareUpdateStore.selectedFile.imageSize),1)])):h("",!0)]),_:1}),e.firmwareUpdateStore.currentState.progressText&&e.firmwareUpdateStore.currentState.busy?(i(),r("div",K,[W,d(" "+o(e.firmwareUpdateStore.currentState.progressText),1)])):(i(),r("div",q,o(e.firmwareUpdateStore.currentState.infoText),1)),e.firmwareUpdateStore.errorText?(i(),r("div",J,o(e.firmwareUpdateStore.errorText),1)):h("",!0)]),t("div",Q,[t("button",{onClick:s[4]||(s[4]=a=>e.stateAction()),class:"bg-canvas-slate-800 text-white p-4 w-full h-full disabled:opacity-25 cursor-pointer",disabled:e.firmwareUpdateStore.currentState.busy||!e.firmwareUpdateStore.currentState.ready},o(e.firmwareUpdateStore.currentState.actionText),9,X)])],64)}const ee=U(D,[["render",Y]]);export{ee as default};
