import{_ as g,d as U,o as r,c as i,b as t,t as n,F as w,r as v,f as b,w as y,T as _,a as c,e as h,x as l,i as k,u as T,j as f,n as u}from"./index-2b0b4acd.js";const D=U({name:"UpdateFirmwareView",setup(){const e="DA2E7828-FBCE-4E01-AE9E-261174997C48";return{xbit:l,firmwareUpdateStore:k(),GUID_SMP:e,devicesStore:T()}},data(){return{images:[],selectedFile:!1,pendingFile:!1,jsonDataListener:null,progressInfo:"",updateFirmwareAction:"Update Firmware",settingUpSmp:!1,readingImageState:!1,testingImageState:!1,confirmingImageState:!1,erasingImage:!1,resetting:!1,uploading:!1,testButtonDisabled:!0,confirmButtonDisabled:!0,eraseButtonDisabled:!1,timeRemaining:0}},async mounted(){this.devicesStore.connected||this.$router.replace({name:"scan"}),this.firmwareUpdateStore.mcumgr.onMessage(async({op:e,group:s,id:d,data:o,length:m})=>{switch(s){case f.MGMT_GROUP_ID_OS:switch(d){case f.OS_MGMT_ID_ECHO:alert(o.r);break;case f.OS_MGMT_ID_TASKSTAT:console.table(o.tasks);break;case f.OS_MGMT_ID_MPSTAT:console.log(o);break}break;case f.MGMT_GROUP_ID_IMAGE:switch(d){case f.IMG_MGMT_ID_STATE:this.firmwareUpdateStore.processReadStateResponse(o)}}}),this.jsonDataListener=e=>{if(e.method==="filePickerSelected"){for(var s=atob(e.params.imageData),d=new Uint8Array(s.length),o=0;o<s.length;o++)d[o]=s.charCodeAt(o);const m={target:{files:[{name:e.params.name,size:e.params.imageData.length,imageData:d,path:"",lastModified:Date.now()}]}};this.firmwareUpdateStore.selectFile(m)}},l.addEventListener("bluetoothNotificationReceived",this.jsonDataListener),l.addEventListener("filePickerSelected",this.jsonDataListener),this.$watch("devicesStore.connected",async e=>{if(e)l.sendClearToast();else{if(this.firmwareUpdateStore.resetting)return;this.firmwareUpdateStore.uploading||this.firmwareUpdateStore.deselectFile(),l.sendToast({type:"error",message:"Disconnected"}),this.mfirmwareUpdateStore.mcumgr.reset(),this.$router.push({name:"scan"})}}),this.$watch("firmwareUpdateStore.state",async e=>{e===0?setTimeout(()=>{this.stateAction()},100):e===1&&setTimeout(()=>{this.stateAction()},100)}),this.firmwareUpdateStore.setState(0)},async beforeRouteLeave(){if(l.removeEventListener("jsonData",this.jsonDataListener),this.firmwareUpdateStore.uploading)return l.sendToast({type:"error",message:"Uploading in progress, please wait."}),!1;this.firmwareUpdateStore.resetStateMachine()},methods:{async stateAction(){if(this.firmwareUpdateStore.state===0)try{await this.firmwareUpdateStore.detectSmp(),this.nextState()}catch(e){console.log("error detecting  SMP",e)}else if(this.firmwareUpdateStore.state===1)try{await this.firmwareUpdateStore.readImageState()}catch(e){console.error("error reading image state",e)}else if(this.firmwareUpdateStore.state===2)this.firmwareUpdateStore.imageUpload();else if(this.firmwareUpdateStore.state===3)this.firmwareUpdateStore.imageTest();else if(this.firmwareUpdateStore.state===4)try{this.reset()}catch(e){console.error("error resetting",e),this.$router.replace({name:"scan"})}else this.firmwareUpdateStore.state===5?this.firmwareUpdateStore.eraseImage():this.firmwareUpdateStore.state===6?this.firmwareUpdateStore.imageConfirm():this.firmwareUpdateStore.state===7&&this.$router.replace({name:"scan"})},nextState(){this.firmwareUpdateStore.setState(this.firmwareUpdateStore.state+1)},async reset(){if(this.firmwareUpdateStore.state!==4)return;l.sendToast({message:"Resetting... Please wait.",options:{autoClose:!1}}),this.firmwareUpdateStore.currentState.busy=!0;const e=this.devicesStore.connected;return await l.sendBleWriteCommand({data:this.firmwareUpdateStore.mcumgr.cmdReset(),uuid:this.firmwareUpdateStore.smpCharId,deviceAddress:this.devicesStore.connected}),await this.devicesStore.startScanning(120*1e3),new Promise((s,d)=>{const o=setTimeout(async()=>{await this.devicesStore.stopScanning(),this.firmwareUpdateStore.currentState.busy=!1,d()},12e4);this.timeRemaining=120;const m=setInterval(async()=>{this.timeRemaining--;let S=null;for(const a of this.devicesStore.devices)if(a.address===e){S=a,this.devicesStore.selectDevice(a);break}try{S&&(clearInterval(m),clearTimeout(o),this.firmwareUpdateStore.currentState.busy=!1,await this.devicesStore.stopScanning(),await this.devicesStore.connectDevice(S),this.firmwareUpdateStore.setState(0))}catch(a){console.error("error resetting",a)}s()},1e3)})},filePicker(){l.sendFilePickerCommand({accept:".bin"})},deselectFile(){this.firmwareUpdateStore.deselectFile();try{this.$refs.fileInput.value=""}catch{}}}}),F={class:"pl-4 p-2 mb-2 text-white btn-gradient-1"},I={class:"p-2"},M={key:0},C={key:1},A={class:"flex flex-col",style:{flex:"1 1 auto","overflow-y":"auto","overflow-x":"hidden","max-width":"48rem"}},E={class:"flex max-[575px]:flex-col"},P=t("i",{class:"fa-solid fa-microchip py-2 my-2"},null,-1),$=["disabled"],R=t("i",{class:"fa-solid fa-trash-can"},null,-1),G=[R],L={key:0},B=t("i",{class:"fa-solid fa-arrows-rotate fa-spin"},null,-1),j=[B],x={key:1},O={class:"whitespace-nowrap"},V={key:2,class:"mt-2"},N=t("i",{class:"fa-solid fa-file-code"},null,-1),z={key:0,class:"bg-canvas-slate-700 text-white p-2 m-2"},W=t("i",{class:"fa-solid fa-microchip py-2 my-2"},null,-1),H=t("i",{class:"fas fa-times"},null,-1),K=[H],q={key:0,class:"text-white m-2 p-2 bg-canvas-sky-700"},J=t("i",{class:"fa-solid fa-spinner fa-spin"},null,-1),Q={key:1,class:"text-white m-2 p-2 bg-canvas-sky-700"},X={key:2,class:"text-white m-2 p-2 bg-canvas-pink-300"},Y={class:"action-button btn-gradient-1"},Z=["disabled"];function ee(e,s,d,o,m,S){return r(),i(w,null,[t("h3",F,[t("span",I,[e.devicesStore.connected?(r(),i("span",M,"Connected to "+n(e.xbit.formatAddress(e.devicesStore.connected)),1)):(r(),i("span",C,"Scanning For Device "+n(this.timeRemaining),1))])]),t("div",A,[t("div",E,[(r(!0),i(w,null,v(e.firmwareUpdateStore.images,a=>(r(),i("div",{key:a.slot,class:"p-2 m-2 text-white bg-canvas-slate-700 grow"},[t("h3",null,[P,c(" Slot "+n(a.slot+1)+" ",1),a.slot===1&&!e.uploading&&!a.empty?(r(),i("button",{key:0,class:"bg-canvas-slate-600 text-white p-2 m-2 rounded disabled:opacity-25 float-right",onClick:s[0]||(s[0]=(...p)=>e.firmwareUpdateStore.imageErase&&e.firmwareUpdateStore.imageErase(...p)),disabled:e.firmwareUpdateStore.states[5].busy},G,8,$)):h("",!0)]),e.firmwareUpdateStore.erasing||e.firmwareUpdateStore.reading?(r(),i("div",L,j)):a.empty?h("",!0):(r(),i("div",x,[t("div",O,"Version: "+n(a.version),1),t("div",null,[c("Pending "),t("i",{class:u({"fa-solid fa-circle-check":a.pending,"fa-regular fa-circle":!a.pending})},null,2)]),t("div",null,[c("Confirmed "),t("i",{class:u({"fa-solid fa-circle-check":a.confirmed,"fa-regular fa-circle":!a.confirmed})},null,2)]),t("div",null,[c("Bootable "),t("i",{class:u({"fa-solid fa-circle-check":a.bootable,"fa-regular fa-circle":!a.bootable})},null,2)])])),a.slot===1?(r(),i("div",V,[t("label",{class:"bg-canvas-slate-600 text-white p-2 rounded cursor-pointer block text-center",for:"fileInput",onClick:s[1]||(s[1]=(...p)=>e.filePicker&&e.filePicker(...p))},[N,c(" Select Update Image To Upload ")]),t("input",{type:"file",id:"fileInput",onChange:s[2]||(s[2]=(...p)=>e.firmwareUpdateStore.selectFile&&e.firmwareUpdateStore.selectFile(...p)),class:"hidden",accept:".bin"},null,32)])):h("",!0)]))),128))]),b(_,{name:"fade",mode:"out-in"},{default:y(()=>[e.firmwareUpdateStore.selectedFile?(r(),i("div",z,[t("h3",null,[W,c(" Selected File "),t("button",{onClick:s[3]||(s[3]=a=>e.deselectFile()),class:"float-right text-canvas-slate-500 hover:text-white"},K)]),t("div",null,"Version: "+n(e.firmwareUpdateStore.selectedFile.version),1),t("div",null,"File Name: "+n(e.firmwareUpdateStore.selectedFile.name),1),t("div",null,"File Last Modified: "+n(e.xbit.toDate(e.firmwareUpdateStore.selectedFile.lastModified)),1),t("div",null,"Image Size: "+n(e.firmwareUpdateStore.selectedFile.imageSize),1)])):h("",!0)]),_:1}),e.firmwareUpdateStore.currentState.progressText&&e.firmwareUpdateStore.currentState.busy?(r(),i("div",q,[J,c(" "+n(e.firmwareUpdateStore.currentState.progressText),1)])):(r(),i("div",Q,n(e.firmwareUpdateStore.currentState.infoText),1)),e.firmwareUpdateStore.errorText?(r(),i("div",X,n(e.firmwareUpdateStore.errorText),1)):h("",!0)]),t("div",Y,[t("button",{onClick:s[4]||(s[4]=a=>e.stateAction()),class:"bg-canvas-slate-800 text-white p-4 w-full h-full disabled:opacity-25 cursor-pointer",disabled:e.firmwareUpdateStore.currentState.busy||!e.firmwareUpdateStore.currentState.ready},n(e.firmwareUpdateStore.currentState.actionText),9,Z)])],64)}const ae=g(D,[["render",ee]]);export{ae as default};
